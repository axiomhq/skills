name: Evaluate Changed Skills

on:
  pull_request:
    paths:
      - 'skills/**'
  workflow_dispatch:
    inputs:
      skill:
        description: 'Skill to evaluate (leave empty to detect from branch diff)'
        required: false
        type: string

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      skills: ${{ steps.changed-skills.outputs.skills }}
      has_evals: ${{ steps.changed-skills.outputs.has_evals }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed skills with evals
        id: changed-skills
        run: |
          # If skill input is provided, use it directly
          if [ -n "${{ inputs.skill }}" ]; then
            skill="${{ inputs.skill }}"
            eval_file="skills/${skill}/.meta/${skill}.eval.ts"
            if [ -f "$eval_file" ]; then
              echo "skills=[\"${skill}\"]" >> $GITHUB_OUTPUT
              echo "has_evals=true" >> $GITHUB_OUTPUT
              echo "Running eval for manually specified skill: ${skill}"
              exit 0
            else
              echo "No eval file found for skill: ${skill}"
              echo "skills=[]" >> $GITHUB_OUTPUT
              echo "has_evals=false" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi

          # Get list of changed files in the PR
          base_ref="${{ github.base_ref }}"
          if [ -z "$base_ref" ]; then
            base_ref="main"
          fi
          changed_files=$(git diff --name-only origin/${base_ref}...HEAD)
          
          # Extract unique skill names from changed paths (skills/<skill>/...)
          skills=$(echo "$changed_files" | grep '^skills/' | cut -d'/' -f2 | sort -u)
          
          # Filter to only skills that have eval files
          skills_with_evals=""
          for skill in $skills; do
            eval_file="skills/${skill}/.meta/${skill}.eval.ts"
            if [ -f "$eval_file" ]; then
              if [ -n "$skills_with_evals" ]; then
                skills_with_evals="${skills_with_evals},${skill}"
              else
                skills_with_evals="${skill}"
              fi
            fi
          done
          
          # Output as JSON array for matrix
          if [ -n "$skills_with_evals" ]; then
            json_array=$(echo "$skills_with_evals" | tr ',' '\n' | jq -R . | jq -s -c .)
            echo "skills=$json_array" >> $GITHUB_OUTPUT
            echo "has_evals=true" >> $GITHUB_OUTPUT
            echo "Skills with evals to run: $skills_with_evals"
          else
            echo "skills=[]" >> $GITHUB_OUTPUT
            echo "has_evals=false" >> $GITHUB_OUTPUT
            echo "No skills with evals found in changed files"
          fi

  run-evals:
    needs: detect-changes
    if: needs.detect-changes.outputs.has_evals == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        skill: ${{ fromJson(needs.detect-changes.outputs.skills) }}
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: 9

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          cache-dependency-path: eval-tooling/pnpm-lock.yaml

      - name: Install dependencies
        working-directory: eval-tooling
        run: pnpm install

      - name: Run eval for ${{ matrix.skill }}
        working-directory: eval-tooling
        env:
          AI_GATEWAY_API_KEY: ${{ secrets.AI_GATEWAY_API_KEY }}
          AXIOM_TOKEN: ${{ secrets.AXIOM_TOKEN }}
          AXIOM_DATASET: ${{ secrets.AXIOM_DATASET }}
          AXIOM_URL: ${{ secrets.AXIOM_URL }}
        run: |
          echo "Running eval for skill: ${{ matrix.skill }}"
          pnpm exec axiom eval ../skills/${{ matrix.skill }}/.meta/${{ matrix.skill }}.eval.ts
