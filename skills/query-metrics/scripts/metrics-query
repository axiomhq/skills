#!/usr/bin/env bash
# metrics-query: Execute a metrics query against Axiom MetricsDB
#
# Usage: metrics-query <deployment> <apl> <startTime> <endTime>
#
# Uses 'metrics_url' from ~/.axiom.toml (falls back to 'url').
# Times must be RFC3339 (e.g. 2025-01-01T00:00:00Z). Relative expressions
# like "now" or "now-1h" are NOT supported.
#
# Examples:
#   metrics-query prod 'otel-metrics:http.server.duration | align to 5m using avg' \
#     '2025-06-01T00:00:00Z' '2025-06-02T00:00:00Z'

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

DEPLOYMENT="${1:-}"
APL="${2:-}"
START_TIME="${3:-}"
END_TIME="${4:-}"

if [[ -z "$DEPLOYMENT" || -z "$APL" || -z "$START_TIME" || -z "$END_TIME" ]]; then
    echo "Usage: metrics-query <deployment> <apl> <startTime> <endTime>" >&2
    echo "" >&2
    echo "Times must be RFC3339 (e.g. 2025-01-01T00:00:00Z)." >&2
    echo "Relative expressions like 'now' or 'now-1h' are NOT supported." >&2
    exit 1
fi

source "$SCRIPT_DIR/config" "$DEPLOYMENT"

BODY=$(jq -n \
    --arg apl "$APL" \
    --arg start "$START_TIME" \
    --arg end "$END_TIME" \
    '{apl: $apl, startTime: $start, endTime: $end}')

curl -s -X POST "${AXIOM_METRICS_URL}/v1/query/_metrics?format=metrics-v1" \
    -H "Authorization: Bearer $AXIOM_TOKEN" \
    -H "X-Axiom-Org-Id: $AXIOM_ORG_ID" \
    -H "Content-Type: application/json" \
    -H "Accept: application/json" \
    -d "$BODY"
