#!/usr/bin/env bash
# axiom-api: Make authenticated requests to Axiom API
#
# Usage: axiom-api <deployment> <method> <path> [json-body]
#
# Reads credentials from ~/.axiom.toml via scripts/config.
# Uses the standard 'url' field (not metrics_url).
#
# Examples:
#   axiom-api prod GET /v1/datasets
#   axiom-api prod POST /v1/datasets/_apl '{"apl":"..."}'

set -euo pipefail

DEPLOYMENT="${1:-}"
METHOD="${2:-}"
PATH_="${3:-}"
BODY="${4:-}"

if [[ -z "$DEPLOYMENT" || -z "$METHOD" || -z "$PATH_" ]]; then
    echo "Usage: axiom-api <deployment> <method> <path> [json-body]" >&2
    exit 1
fi

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/config" "$DEPLOYMENT"

CURL_ARGS=(
    -s
    -X "$METHOD"
    -H "Authorization: Bearer $AXIOM_TOKEN"
    -H "X-Axiom-Org-Id: $AXIOM_ORG_ID"
    -H "Content-Type: application/json"
    -H "Accept: application/json"
)

if [[ -n "$BODY" ]]; then
    CURL_ARGS+=(-d "$BODY")
fi

curl "${CURL_ARGS[@]}" "${AXIOM_URL}${PATH_}"
