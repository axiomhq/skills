#!/usr/bin/env bash
# metrics-spec: Fetch the metrics query specification from Axiom
#
# Usage: metrics-spec <deployment>
#
# Calls OPTIONS /v1/query/_metrics to retrieve the complete metrics query
# spec with syntax, operators, and examples. Read this before composing queries.
#
# Example:
#   metrics-spec prod

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

DEPLOYMENT="${1:-}"

if [[ -z "$DEPLOYMENT" ]]; then
    echo "Usage: metrics-spec <deployment>" >&2
    exit 1
fi

CONFIG_FILE="$HOME/.axiom.toml"
if [[ ! -f "$CONFIG_FILE" ]]; then
    echo "Error: $CONFIG_FILE not found. Run scripts/setup for help." >&2
    exit 1
fi

# Parse TOML for deployment config
extract_value() {
    local key="$1"
    awk -v deployment="$DEPLOYMENT" -v key="$key" '
        /^\[deployments\./ { in_deployment = ($0 ~ "\\[deployments\\." deployment "\\]") }
        in_deployment && $1 == key { gsub(/[" ]/, "", $3); print $3; exit }
    ' "$CONFIG_FILE"
}

URL=$(extract_value "url")

if [[ -z "$URL" ]]; then
    echo "Error: Could not find deployment '$DEPLOYMENT' in $CONFIG_FILE" >&2
    exit 1
fi

curl -s -X OPTIONS "${URL}/v1/query/_metrics"
