#!/usr/bin/env bash
# Axiom API helper - uses unified config
# Usage: axiom-api <deployment> <method> <endpoint> [body]
# Examples:
#   axiom-api dev POST "/v1/datasets/_apl?format=tabular" '{"apl": "..."}'
#   axiom-api dev GET "/v1/datasets"

set -euo pipefail

DEPLOYMENT="${1:-}"
METHOD="${2:-GET}"
ENDPOINT="${3:-}"
BODY="${4:-}"

if [[ -z "$DEPLOYMENT" || -z "$ENDPOINT" ]]; then
  echo "Usage: axiom-api <deployment> <method> <endpoint> [body]" >&2
  exit 1
fi

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Load config from unified config file
eval "$("$SCRIPT_DIR/config" axiom "$DEPLOYMENT")"

URL="$AXIOM_URL"
TOKEN="$AXIOM_TOKEN"
ORG_ID="$AXIOM_ORG_ID"

# Build curl command
CURL_ARGS=(
  -s
  -X "$METHOD"
  "${URL}${ENDPOINT}"
  -H "Authorization: Bearer $TOKEN"
  -H "X-Axiom-Org-Id: $ORG_ID"
  -H "Content-Type: application/json"
)

if [[ -n "$BODY" ]]; then
  CURL_ARGS+=(-d "$BODY")
fi

curl "${CURL_ARGS[@]}"
