#!/usr/bin/env bash
# Gilfoyle setup - creates config directory and migrates existing configs
# Usage: setup [--migrate]
#
# Creates:
#   ~/.config/axiom-sre/config.toml
#   ~/.config/axiom-sre/memory/kb/
#
# Migrates from (if --migrate):
#   ~/.axiom.toml
#   ~/.grafana.toml
#   ~/.pyroscope.toml
#   ~/.slack.conf

set -euo pipefail

CONFIG_DIR="${SRE_CONFIG_DIR:-$HOME/.config/axiom-sre}"
CONFIG_FILE="$CONFIG_DIR/config.toml"
MEMORY_DIR="$CONFIG_DIR/memory/kb"

MIGRATE="${1:-}"

echo "Gilfoyle Setup"
echo "=============="
echo ""

# Create directories
mkdir -p "$CONFIG_DIR"
mkdir -p "$MEMORY_DIR"
chmod 700 "$CONFIG_DIR"

# Initialize memory files if they don't exist
for kb_file in facts.md patterns.md queries.md incidents.md integrations.md; do
    if [[ ! -f "$MEMORY_DIR/$kb_file" ]]; then
        echo "# ${kb_file%.md}" > "$MEMORY_DIR/$kb_file"
        echo "" >> "$MEMORY_DIR/$kb_file"
    fi
done

echo "Created: $CONFIG_DIR"
echo "Created: $MEMORY_DIR"
echo ""

# Check for existing unified config
if [[ -f "$CONFIG_FILE" && "$MIGRATE" != "--migrate" ]]; then
    echo "Config exists: $CONFIG_FILE"
    echo ""
    echo "Run 'setup --migrate' to merge existing tool configs."
    exit 0
fi

# Start building config
CONFIG_CONTENT=""

# Migrate ~/.axiom.toml
if [[ -f "$HOME/.axiom.toml" ]]; then
    echo "Found: ~/.axiom.toml"
    
    # Parse existing axiom config
    while IFS= read -r line; do
        if [[ "$line" =~ ^\[deployments\.([^\]]+)\] ]]; then
            deployment="${BASH_REMATCH[1]}"
            CONFIG_CONTENT+="
[axiom.deployments.$deployment]"
        elif [[ "$line" =~ ^url[[:space:]]*=[[:space:]]*\"?([^\"]+)\"? ]]; then
            CONFIG_CONTENT+="
url = \"${BASH_REMATCH[1]}\""
        elif [[ "$line" =~ ^token[[:space:]]*=[[:space:]]*\"?([^\"]+)\"? ]]; then
            CONFIG_CONTENT+="
token = \"${BASH_REMATCH[1]}\""
        elif [[ "$line" =~ ^org_id[[:space:]]*=[[:space:]]*\"?([^\"]+)\"? ]]; then
            CONFIG_CONTENT+="
org_id = \"${BASH_REMATCH[1]}\""
        fi
    done < "$HOME/.axiom.toml"
    
    echo "  → Migrated Axiom deployments"
fi

# Migrate ~/.grafana.toml
if [[ -f "$HOME/.grafana.toml" ]]; then
    echo "Found: ~/.grafana.toml"
    
    current_deployment=""
    while IFS= read -r line; do
        if [[ "$line" =~ ^\[deployments\.([^\]]+)\] ]]; then
            current_deployment="${BASH_REMATCH[1]}"
            CONFIG_CONTENT+="

[grafana.deployments.$current_deployment]"
        elif [[ -n "$current_deployment" ]]; then
            if [[ "$line" =~ ^url[[:space:]]*=[[:space:]]*\"?([^\"]+)\"? ]]; then
                CONFIG_CONTENT+="
url = \"${BASH_REMATCH[1]}\"
access_command = \"cloudflared access curl\""
            fi
        fi
    done < "$HOME/.grafana.toml"
    
    echo "  → Migrated Grafana deployments (with cloudflared access)"
fi

# Migrate ~/.pyroscope.toml
if [[ -f "$HOME/.pyroscope.toml" ]]; then
    echo "Found: ~/.pyroscope.toml"
    
    current_deployment=""
    while IFS= read -r line; do
        if [[ "$line" =~ ^\[deployments\.([^\]]+)\] ]]; then
            current_deployment="${BASH_REMATCH[1]}"
            CONFIG_CONTENT+="

[pyroscope.deployments.$current_deployment]"
        elif [[ -n "$current_deployment" ]]; then
            if [[ "$line" =~ ^url[[:space:]]*=[[:space:]]*\"?([^\"]+)\"? ]]; then
                CONFIG_CONTENT+="
url = \"${BASH_REMATCH[1]}\"
access_command = \"cloudflared access curl\""
            fi
        fi
    done < "$HOME/.pyroscope.toml"
    
    echo "  → Migrated Pyroscope deployments (with cloudflared access)"
fi

# Migrate ~/.slack.conf
if [[ -f "$HOME/.slack.conf" ]]; then
    echo "Found: ~/.slack.conf"
    
    current_workspace=""
    while IFS= read -r line; do
        # Skip comments
        [[ "$line" =~ ^[[:space:]]*# ]] && continue
        
        if [[ "$line" =~ ^\[([^\]]+)\] ]]; then
            current_workspace="${BASH_REMATCH[1]}"
            CONFIG_CONTENT+="

[slack.workspaces.$current_workspace]"
        elif [[ -n "$current_workspace" && "$line" =~ ^[[:space:]]*token[[:space:]]*=[[:space:]]*(.+) ]]; then
            token=$(echo "${BASH_REMATCH[1]}" | tr -d '"'"'" | xargs)
            CONFIG_CONTENT+="
token = \"$token\""
        fi
    done < "$HOME/.slack.conf"
    
    echo "  → Migrated Slack workspaces"
fi

# Write config file
if [[ -n "$CONFIG_CONTENT" ]]; then
    cat > "$CONFIG_FILE" << 'EOF'
# Gilfoyle Configuration
# ======================
# Unified config for all observability tools.
#
# Auth options per deployment:
#   token          - Bearer token (Grafana Cloud, API keys)
#   access_command - Custom wrapper (e.g., "cloudflared access curl")
#   username/password - Basic auth (on-prem)

EOF
    echo "$CONFIG_CONTENT" >> "$CONFIG_FILE"
    chmod 600 "$CONFIG_FILE"
    echo ""
    echo "Created: $CONFIG_FILE"
else
    # Create example config
    cat > "$CONFIG_FILE" << 'EOF'
# Gilfoyle Configuration
# ======================
# Unified config for all observability tools.
#
# Auth options per deployment:
#   token          - Bearer token (Grafana Cloud, API keys)
#   access_command - Custom wrapper (e.g., "cloudflared access curl")
#   username/password - Basic auth (on-prem)

# Example Axiom configuration
# [axiom.deployments.prod]
# url = "https://api.axiom.co"
# token = "xapt-xxx"
# org_id = "my-org"

# Example Grafana with API token (cloud)
# [grafana.deployments.cloud]
# url = "https://myorg.grafana.net"
# token = "glsa_xxx"

# Example Grafana with cloudflared (internal)
# [grafana.deployments.internal]
# url = "https://grafana.internal.example.com"
# access_command = "cloudflared access curl"

# Example Grafana with basic auth (on-prem)
# [grafana.deployments.onprem]
# url = "https://grafana.corp.example.com"
# username = "admin"
# password = "secret"

# Example Pyroscope
# [pyroscope.deployments.prod]
# url = "https://pyroscope.example.com"
# token = "xxx"

# Example Slack
# [slack.workspaces.work]
# token = "xoxb-xxx"
EOF
    chmod 600 "$CONFIG_FILE"
    echo ""
    echo "Created example config: $CONFIG_FILE"
    echo "Edit this file to add your deployments."
fi

echo ""
echo "Done. Memory files at: $MEMORY_DIR"
