#!/bin/bash
# Update the Reduction Glidepath monitor threshold
# Usage: update-glidepath -d <deployment> -t <threshold_tb>

set -e

AXIOM_API="${AXIOM_API:-$HOME/.config/agents/skills/sre/scripts/axiom-api}"

# Defaults
DEPLOYMENT=""
NEW_THRESHOLD=""

usage() {
    cat << 'EOF'
Usage: update-glidepath -d <deployment> -t <threshold_tb>

Update the Reduction Glidepath monitor threshold.

Required:
  -d, --deployment NAME    Axiom deployment name
  -t, --threshold TB       New threshold in TB/day

Example glidepath schedule:
  Week 1: 450 TB/day (current p95)
  Week 2: 350 TB/day (-25%)
  Week 3: 250 TB/day (-50%)
  Week 4: 167 TB/day (contract)

Example:
  update-glidepath -d prod -t 350
EOF
    exit 1
}

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        -d|--deployment)
            DEPLOYMENT="$2"
            shift 2
            ;;
        -t|--threshold)
            NEW_THRESHOLD="$2"
            shift 2
            ;;
        -h|--help)
            usage
            ;;
        *)
            echo "Error: Unknown option $1" >&2
            usage
            ;;
    esac
done

# Validate required args
[[ -z "$DEPLOYMENT" ]] && { echo "Error: -d/--deployment required" >&2; usage; }
[[ -z "$NEW_THRESHOLD" ]] && { echo "Error: -t/--threshold required" >&2; usage; }

echo "=== Updating Reduction Glidepath Monitor ==="
echo "Deployment: $DEPLOYMENT"
echo "New threshold: $NEW_THRESHOLD TB/day"
echo ""

# Find the glidepath monitor
MONITORS=$($AXIOM_API "$DEPLOYMENT" GET "/v2/monitors")
MONITOR_ID=$(echo "$MONITORS" | jq -r '.[] | select(.name | contains("Glidepath")) | .id' | head -1)

if [[ -z "$MONITOR_ID" || "$MONITOR_ID" == "null" ]]; then
    echo "Error: Could not find Reduction Glidepath monitor"
    echo "Run 'scripts/create-monitors -d $DEPLOYMENT -a <audit-dataset>' first"
    exit 1
fi

echo "Found monitor: $MONITOR_ID"

# Get current monitor config
CURRENT=$($AXIOM_API "$DEPLOYMENT" GET "/v2/monitors/$MONITOR_ID")
OLD_THRESHOLD=$(echo "$CURRENT" | jq -r '.threshold')

# Update the threshold
UPDATED=$(echo "$CURRENT" | jq --argjson threshold "$NEW_THRESHOLD" '.threshold = $threshold')
RESULT=$($AXIOM_API "$DEPLOYMENT" PUT "/v2/monitors/$MONITOR_ID" "$UPDATED")

if echo "$RESULT" | jq -e '.id' > /dev/null 2>&1; then
    echo "âœ“ Glidepath threshold updated!"
    echo "  Old: $OLD_THRESHOLD TB/day"
    echo "  New: $NEW_THRESHOLD TB/day"
else
    echo "Error updating monitor:"
    echo "$RESULT"
    exit 1
fi
