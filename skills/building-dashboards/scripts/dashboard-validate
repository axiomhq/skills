#!/usr/bin/env bash
# dashboard-validate: Validate a dashboard JSON file
#
# Usage: dashboard-validate <path-to-json> [--strict]
#
# Checks:
#   1. Valid JSON structure
#   2. Required fields present (name, owner, charts, layout)
#   3. Chart IDs match layout IDs
#   4. LogStream queries have take limits
#   5. dashctl lint (if available)
#
# Options:
#   --strict  Treat warnings as errors
#
# Examples:
#   dashboard-validate ./dashboard.json
#   dashboard-validate ./dashboard.json --strict

set -uo pipefail

STRICT=false
FILE=""

for arg in "$@"; do
    case $arg in
        --strict)
            STRICT=true
            ;;
        *)
            FILE="$arg"
            ;;
    esac
done

if [[ -z "$FILE" ]]; then
    echo "Usage: dashboard-validate <path-to-json> [--strict]"
    exit 2
fi

if [[ ! -f "$FILE" ]]; then
    echo "Error: File not found: $FILE"
    exit 2
fi

errors=0
warnings=0

error() {
    echo "ERROR: $1"
    errors=$((errors + 1))
}

warn() {
    echo "WARN: $1"
    warnings=$((warnings + 1))
}

info() {
    echo "INFO: $1"
}

# 1. Check valid JSON
if ! jq empty "$FILE" 2>/dev/null; then
    echo "ERROR: Invalid JSON"
    exit 1
fi
info "Valid JSON structure"

# 2. Check required fields
for field in name owner; do
    if [[ $(jq -r ".$field // empty" "$FILE") == "" ]]; then
        error "Missing required field: $field"
    fi
done

# 3. Check charts array exists
if [[ $(jq -r '.charts // "null"' "$FILE") == "null" ]]; then
    error "Missing charts array"
fi

# 4. Check layout array exists
if [[ $(jq -r '.layout // "null"' "$FILE") == "null" ]]; then
    error "Missing layout array"
fi

# 5. Check chart IDs match layout IDs
chart_ids=$(jq -r '.charts[].id' "$FILE" 2>/dev/null | sort)
layout_ids=$(jq -r '.layout[].i' "$FILE" 2>/dev/null | sort)

if [[ "$chart_ids" != "$layout_ids" ]]; then
    warn "Chart IDs and layout IDs don't match"
    echo "  Charts: $(echo $chart_ids | tr '\n' ' ')"
    echo "  Layout: $(echo $layout_ids | tr '\n' ' ')"
fi

# 6. Dashboard queries inherit time from UI picker - no time filter needed
# (Previously warned about missing time filters, but dashboard panels don't need them)

# 7. Check LogStream queries for take limits
logstream_without_take=$(jq -r '.charts[] | select(.type == "LogStream") | select(.query.apl != null) | select(.query.apl | test("take ") | not) | .id' "$FILE" 2>/dev/null || true)
if [[ -n "$logstream_without_take" ]]; then
    for id in $logstream_without_take; do
        warn "LogStream '$id' may be missing 'take N' limit"
    done
fi

# 8. Run dashctl lint if available
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
DASHCTL_DIR="${DASHCTL_DIR:-$HOME/.local/share/dashctl}"

if [[ -f "$DASHCTL_DIR/dashctl.js" ]] && command -v bun &> /dev/null; then
    info "Running dashctl lint..."
    if (cd "$DASHCTL_DIR" && bun run dashctl.js lint "$FILE" 2>&1); then
        info "dashctl lint passed"
    else
        warn "dashctl lint reported issues (see above)"
    fi
else
    info "Skipping dashctl lint (run scripts/setup to install dashctl)"
fi

# Summary
echo ""
echo "Validation complete: $errors errors, $warnings warnings"

if [[ $errors -gt 0 ]]; then
    exit 1
fi

if [[ "$STRICT" == "true" && $warnings -gt 0 ]]; then
    exit 1
fi

exit 0
