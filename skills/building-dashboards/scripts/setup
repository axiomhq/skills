#!/usr/bin/env bash
# Setup building-dashboards skill
# Usage: scripts/setup [--force]
#
# This script:
#   1. Checks for bun (required by dashctl)
#   2. Clones/updates dashctl
#   3. Checks for ~/.axiom.toml (shared with axiom-sre)

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SKILL_DIR="$(dirname "$SCRIPT_DIR")"

# Default dashctl location
DASHCTL_DIR="${DASHCTL_DIR:-$HOME/.local/share/dashctl}"
DASHCTL_REPO="https://github.com/axiomhq/dashctl.git"

FORCE=false
for arg in "$@"; do
  case $arg in
    --force) FORCE=true ;;
  esac
done

echo "=== building-dashboards Setup ==="
echo ""

# --- Check bun ---
echo "[1/3] Checking bun..."
if command -v bun &> /dev/null; then
  BUN_VERSION=$(bun --version)
  echo "✓ bun $BUN_VERSION found"
else
  echo "✗ bun not found"
  echo ""
  echo "Install bun:"
  echo "  curl -fsSL https://bun.sh/install | bash"
  exit 1
fi

# --- Clone/update dashctl ---
echo ""
echo "[2/3] Setting up dashctl at $DASHCTL_DIR..."

if [[ -d "$DASHCTL_DIR/.git" ]]; then
  if [[ "$FORCE" == true ]]; then
    echo "Removing existing dashctl (--force)..."
    rm -rf "$DASHCTL_DIR"
  else
    echo "Updating existing dashctl..."
    (cd "$DASHCTL_DIR" && git pull --quiet)
    (cd "$DASHCTL_DIR" && bun install --silent)
    echo "✓ dashctl updated"
  fi
fi

if [[ ! -d "$DASHCTL_DIR" ]]; then
  echo "Cloning dashctl..."
  git clone --quiet "$DASHCTL_REPO" "$DASHCTL_DIR"
  (cd "$DASHCTL_DIR" && bun install --silent)
  echo "✓ dashctl installed"
fi

# Verify dashctl works
if [[ -f "$DASHCTL_DIR/dashctl.js" ]]; then
  echo "✓ dashctl ready at $DASHCTL_DIR"
else
  echo "✗ dashctl.js not found in $DASHCTL_DIR"
  exit 1
fi

# --- Check Axiom config ---
echo ""
echo "[3/3] Checking Axiom configuration..."

AXIOM_CONFIG="$HOME/.axiom.toml"
if [[ -f "$AXIOM_CONFIG" ]]; then
  # Count deployments
  DEPLOYMENTS=$(grep -c '^\[deployments\.' "$AXIOM_CONFIG" 2>/dev/null || echo 0)
  echo "✓ Found $AXIOM_CONFIG with $DEPLOYMENTS deployment(s)"
else
  echo "⚠ $AXIOM_CONFIG not found"
  echo ""
  echo "Create it to enable dashboard operations:"
  echo ""
  cat << 'EOF'
[deployments.prod]
url = "https://api.axiom.co"
token = "xaat-your-token-here"
org_id = "your-org-id"

[deployments.staging]
url = "https://api.axiom.co"
token = "xaat-your-staging-token"
org_id = "your-org-id"
EOF
  echo ""
fi

echo ""
echo "=== Setup Complete ==="
echo ""
echo "dashctl: $DASHCTL_DIR"
echo "config:  $AXIOM_CONFIG"
echo ""
echo "Usage:"
echo "  scripts/get-user-id prod                 # Get your user ID for dashboard creation"
echo "  scripts/dashctl prod getAll --summary    # List dashboards"
echo "  scripts/dashctl prod get <dashboard-id>  # Get dashboard JSON"
echo "  scripts/dashctl prod create ./dashboard.json"
echo ""
echo "Templates:"
echo "  USER_ID=\$(scripts/get-user-id prod)"
echo "  scripts/dashboard-from-template service-overview <service> \$USER_ID <dataset>"
echo ""
