#!/usr/bin/env bash
# Setup axiom-sre memory system
# Usage: scripts/setup [--project] [--force]
#   --project  Use project-local memory (.agents/memory/axiom-sre)
#   --force    Overwrite existing memory without prompting
#   default    Use global memory (~/.config/amp/memory/axiom-sre)

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SKILL_DIR="$(dirname "$SCRIPT_DIR")"
TEMPLATES_DIR="$SKILL_DIR/templates"

PROJECT=false
FORCE=false

for arg in "$@"; do
  case $arg in
    --project) PROJECT=true ;;
    --force) FORCE=true ;;
  esac
done

if [[ "$PROJECT" == true ]]; then
  MEMORY_DIR=".agents/memory/axiom-sre"
  echo "Setting up project-local memory at $MEMORY_DIR"
else
  MEMORY_DIR="$HOME/.config/amp/memory/axiom-sre"
  echo "Setting up global memory at $MEMORY_DIR"
fi

if [[ -d "$MEMORY_DIR/kb" ]]; then
  if [[ "$FORCE" != true ]]; then
    echo "Memory already exists at $MEMORY_DIR"
    exit 0
  fi
fi

mkdir -p "$MEMORY_DIR"
cp -r "$TEMPLATES_DIR"/* "$MEMORY_DIR/"

echo "Done. Memory system initialized at $MEMORY_DIR"

# Check for Axiom config
AXIOM_CONFIG="$HOME/.axiom.toml"
if [[ ! -f "$AXIOM_CONFIG" ]]; then
  echo ""
  echo "Optional: To enable Axiom queries, create $AXIOM_CONFIG:"
  echo ""
  echo '[deployments.dev]'
  echo 'url = "https://api.axiom.co"'
  echo 'token = "xaat-your-token-here"'
  echo 'org_id = "your-org-id"'
fi
